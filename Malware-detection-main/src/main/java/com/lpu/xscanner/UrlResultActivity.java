package com.lpu.xscanner;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import android.os.Build;
import android.os.Bundle;
import android.util.Log;
import android.widget.TextView;

import com.urlscanner.urlscanner2.ScanListener;
import com.urlscanner.urlscanner2.UrlScanBuilder;

import org.json.JSONException;
import org.json.JSONObject;

import java.util.Iterator;
import java.util.List;

public class UrlResultActivity extends AppCompatActivity {

    private TextView urlTextView;
    private TextView textView1;
    private String TAG = "MainActivity";
    private String apiKey;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_url_result);

        urlTextView = findViewById(R.id.urlTextView);
        textView1 = findViewById(R.id.textview1);

        // Retrieve the URL and apiKey from the Intent
        String url = getIntent().getStringExtra("url");
        apiKey = getIntent().getStringExtra("apiKey");

        if (url != null && !url.isEmpty()) {
            // Initialize UrlScanBuilder and start scanning
            UrlScanBuilder UrlScanBuilder = new UrlScanBuilder(getApplicationContext(), apiKey);
            UrlScanBuilder.setScanListener(scanListener);
            UrlScanBuilder.scanUrl(url);
        }
    }

    private ScanListener scanListener = new ScanListener() {
        @Override
        public void scanItemFailed(int cause, @Nullable Exception e) {
            Log.v(TAG, "Scan Failed " + cause + " e " + e);
        }

        @Override
        public void scanItemResult(int status, int totalAv, int positives, String jsonResult) {
            // Handle the scan results for the single URL here
            // You can update the UI or perform any required actions

            urlTextView.setText("URL: " + getIntent().getStringExtra("url")); // Display the URL

            textView1.setText("Status:\n " + status);
            textView1.setText(" Detected in " + positives + " Out of" + " Total  " + totalAv);
            try {
                JSONObject obj = new JSONObject(jsonResult);
                String resource = obj.getString("resource");
                //textView1.setText(String.format("%s\n url : %s", textView1.getText(), resource));
                Log.v(TAG, "resource : " + resource);
                String  scans = obj.getString("scans");
                JSONObject jsonObject = new JSONObject(scans.trim());
                Iterator<String> keys = jsonObject.keys();
                int i = 1;
                while(keys.hasNext()) {
                    String key = keys.next();

                    if (jsonObject.get(key) instanceof JSONObject) {
                        String val1 = ((JSONObject) jsonObject.get(key)).getString("detected");
                        String val2 = ((JSONObject) jsonObject.get(key)).getString("result");
                        if(val1 == "true")
                        {

                            // You can initialize this with the appropriate serial number
                            String newText = String.format("%s\n%d. %s: %s", textView1.getText(), i++, key,val2);
                            textView1.setText(newText);
                        }
                    }
                }
                if(i == 1){

                    textView1.setText("The URL is Not Malicious Site");
                }


            } catch (JSONException e) {
                Log.v(TAG, "Response Exc " + Log.getStackTraceString(e));
            }
        }

        @Override
        public void scanFinalResult(List<String> jsonResults) {
            Log.v(TAG, "json Res " + jsonResults.size());
        }
    };
}
